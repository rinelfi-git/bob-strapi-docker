name: bob

services:
  redis:
    build:
      context: ./redis
      dockerfile: Dockerfile
    volumes:
      - redis-data:/data
      - ${STRAPI_VOLUME}:/app/bob
    restart: unless-stopped
    networks:
      - bob-network
    healthcheck:
      test: ["CMD-SHELL", "test -f /data/redis_password.txt && redis-cli -a $(cat /data/redis_password.txt) ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  strapi:
    build:
      context: ./strapi
      dockerfile: Dockerfile
    ports:
      - "${STRAPI_HOST:-0.0.0.0}:1337:1337"
    volumes:
      - ${STRAPI_VOLUME}:/app/bob
    environment:
      - NODE_ENV=${NODE_ENV}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - LIVEKIT_URL=${LIVEKIT_URL}
    depends_on:
      redis:
        condition: service_healthy
      livekit:
        condition: service_started
    restart: unless-stopped
    networks:
      - bob-network

  livekit:
    image: livekit/livekit-server:latest
    container_name: bob-livekit
    restart: unless-stopped
    ports:
      # LiveKit = serveur RTC + TURN, doit toujours être accessible depuis l'extérieur
      - "7880:7880"                       # HTTP/WebSocket API
      - "7881:7881/tcp"                   # RTC over TCP
      - "3478:3478/udp"                   # TURN UDP
      - "3478:3478/tcp"                   # TURN TCP (fallback)
      - "50000-50200:50000-50200/udp"     # RTC over UDP (200 ports for 50 participants)
    volumes:
      - ./livekit/livekit.yaml:/livekit.yaml
    command: --config /livekit.yaml --node-ip ${LIVEKIT_EXTERNAL_IP}
    # Resource limits for 50 participants
    # Rule of thumb: ~100MB RAM per participant, ~0.1 CPU per video stream
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 6G
        reservations:
          cpus: '1'
          memory: 1G
    # UDP buffer sizes for better RTC performance (scaled for 50 participants)
    sysctls:
      - net.core.rmem_max=8000000
      - net.core.wmem_max=8000000
      - net.core.netdev_max_backlog=5000
    networks:
      - bob-network

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: bob-web
    ports:
      - "${WEB_HOST:-0.0.0.0}:3000:3000"
    volumes:
      - ${WEB_VOLUME:-../web}:/app/web
    environment:
      - NODE_ENV=development
      # URL côté client (navigateur) - localhost car le navigateur accède depuis la machine hôte
      - NEXT_PUBLIC_API_URL=http://localhost:1337
      - NEXT_PUBLIC_SIGNALING_URL=ws://localhost:1337
      # URL côté serveur (SSR) - nom du service Docker
      - API_URL=http://strapi:1337
    depends_on:
      - strapi
    restart: unless-stopped
    networks:
      - bob-network

networks:
  bob-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
