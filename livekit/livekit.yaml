port: 7880

rtc:
  # Port range: ~2 ports per participant per media type (audio+video)
  # 50 participants × 2 streams × 2 ports = 200 ports minimum
  port_range_start: 50000
  port_range_end: 50200
  use_external_ip: true
  tcp_port: 7881

  # Allow fallback to TCP/TURN when UDP is unstable (important for mobile)
  allow_tcp_fallback: true

  # ══════════════════════════════════════════════════════════════════════
  # LATENCY OPTIMIZATION - Based on LiveKit documentation
  # https://github.com/livekit/livekit/blob/master/config-sample.yaml
  # ══════════════════════════════════════════════════════════════════════

  # Packet buffer sizes - REDUCED for lower latency
  # Default is 500/200, but smaller buffers = less delay
  # Trade-off: may increase packet loss impact on poor networks
  packet_buffer_size_video: 200
  packet_buffer_size_audio: 100

  # PLI = Picture Loss Indication - request keyframe on packet loss
  # VERY AGGRESSIVE for Android→iOS H.264 compatibility
  # Frequent keyframes help recover from profile/decoding issues
  pli_throttle:
    low_quality: 100ms    # Very fast keyframe requests
    mid_quality: 200ms
    high_quality: 400ms   # More frequent than default

  # Congestion control - better adaptation to network changes
  congestion_control:
    enabled: true
    # allow_pause: Pause low-priority tracks during congestion
    # Set to false to prevent video freezing, prefer quality degradation instead
    allow_pause: false

# TURN configuration for NAT traversal (critical for mobile behind strict NAT)
turn:
  enabled: true
  udp_port: 3478
  # Use the same port range as RTC for relay
  relay_range_start: 50000
  relay_range_end: 50200

# Room configuration for optimized group calls
room:
  # Auto-create rooms when participants join
  auto_create: true
  # Timeout for empty rooms (5 minutes)
  empty_timeout: 300
  # Timeout after last participant leaves (20 seconds)
  departure_timeout: 20
  # Max participants per room
  max_participants: 50
  # Allow remote unmute (for moderation features)
  enable_remote_unmute: true

  # Codec configuration - VP8 for cross-platform compatibility
  #
  # Problem: Android hardware H.264 encoders (especially on budget devices)
  # produce streams that iOS decoders struggle with, causing visual tearing.
  #
  # VP8 is software-encoded, so it's consistent across all devices.
  # CPU impact is minimal on modern devices (2018+).
  enabled_codecs:
    # VP8 - software codec, consistent cross-platform behavior
    - mime: video/VP8
    # Audio - Opus is the standard WebRTC audio codec
    - mime: audio/opus

  # ══════════════════════════════════════════════════════════════════════
  # PLAYOUT DELAY - Critical for latency
  # https://www.gethopp.app/blog/latency-exploration
  # ══════════════════════════════════════════════════════════════════════
  # Lower values = less buffering = lower latency
  # Trade-off: more sensitive to jitter
  playout_delay:
    enabled: true
    min: 0       # Was 100ms - allow minimal buffering
    max: 150     # Was 300ms - reduced maximum buffer

  # Sync audio and video streams for better A/V sync
  # Note: sync_streams adds ~50-100ms latency but improves quality
  # Disable if latency is more important than perfect A/V sync
  sync_streams: false

# Audio configuration for voice activity detection
audio:
  # Speaker detection threshold (0-127, lower = more sensitive)
  active_level: 30
  # Activity detection percentile
  min_percentile: 40
  # How often to update active speakers (ms) - REDUCED for faster updates
  update_interval: 300   # Was 500ms
  # Smoothing samples for stable speaker detection
  smooth_intervals: 2    # Was 4 - faster response
  # Enable RED encoding for Opus (redundancy for packet loss)
  # Adds slight overhead but helps with packet loss recovery
  active_red_encoding: true

# Resource limits
limit:
  # Tracks per CPU core
  num_tracks: 400
  # Max subscriptions per participant (video)
  subscription_limit_video: 10
  # Max subscriptions per participant (audio)
  subscription_limit_audio: 20

keys:
  livekit: sTDqA5LKNRM5jf7rLsD7Z7So23BwiNgb

# Webhook configuration - notify backend when participants join/leave
# api_key must match one of the keys defined above
webhook:
  api_key: livekit
  urls:
    - http://strapi:1337/api/livekit-webhook

logging:
  level: info
  # Enable JSON logs for easier parsing
  json: false

# Prometheus metrics (optional - for monitoring)
# prometheus_port: 6789
