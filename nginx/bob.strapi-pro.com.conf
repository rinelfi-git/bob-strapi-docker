# =============================================================================
# Blue-Green upstream avec failover automatique
#
# strapi-master (port 1337) = serveur principal
# strapi-slave  (port 1338) = serveur backup (prend le relais si master down)
#
# Fonctionnement :
#   - En temps normal : seul master tourne, tout le trafic va sur master
#   - Pendant un deploy : slave demarre, deploy.sh arrete master,
#     nginx bascule automatiquement sur slave via backup
#   - Apres deploy : slave devient le nouveau principal,
#     deploy.sh met a jour ce fichier (swap des roles)
# =============================================================================

upstream strapi_backend {
    server 127.0.0.1:1337 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:1338 max_fails=3 fail_timeout=30s backup;
}

server {
    listen 80;
    listen [::]:80;

    server_name bob.strapi-pro.com;

    # Logs
    access_log /var/log/nginx/bob-strapi-access.log;
    error_log /var/log/nginx/bob-strapi-error.log;

    # Taille maximale des uploads
    client_max_body_size 100M;

    # Proxy vers l'instance Strapi active
    location / {
        proxy_pass http://strapi_backend;
        proxy_http_version 1.1;

        # Failover : si le serveur actif repond avec une erreur, essayer l'autre
        proxy_next_upstream error timeout http_502 http_503;
        proxy_next_upstream_timeout 10s;
        proxy_next_upstream_tries 2;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
